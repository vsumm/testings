var quform=function(e,r,a,o){"use strict";var i=e.core,s=i.cache,t=r(document),n=!1,g=[],m=1,f=0,c=!0,l={init:function(){s.get("#qfb_migrate_forms").change(function(){s.get("#qfb_migrate_forms_custom").closest(i.settingWrap)["specific"==s.get("#qfb_migrate_forms").val()?"qfbSlideShow":"qfbSlideHide"]()}),r.fn.select2&&s.get("#qfb_migrate_forms_custom").select2({theme:"qfb",language:{noResults:function(){return o.noResultsFound}}}),s.get("#qfb-migrate-start").click(l.startMigration),s.get("#qfb-migrate-stop").click(function(){c=!1,s.get("#qfb-migrate-stop-text").text(a.stopping)}),s.get("#qfb-migrate-close").click(function(){s.get("#qfb-migrate-progress").hide(),s.get("body").css("overflow","").removeClass("qfb-popup-open"),s.get("#qfb-migrate-progress-bar-inner").width(0),s.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-info"),s.get("#qfb-migrate-current-task-text").text(a.processing),s.get("#qfb-migrate-close").hide(),s.get("#qfb-migrate-stop-text").text(a.stopMigration),s.get("#qfb-migrate-progress").find(".qfb-submission-error").remove(),s.get("#qfb-migrate-errors").empty()}),s.get("#qfb-import-form-button").click(l["import"]),t.on("heartbeat-tick",function(e,t){t&&t.nonces_expired&&(t.quformMigrateSettingsNonce&&a.migrateSettingsNonce!==t.quformMigrateSettingsNonce&&(a.migrateSettingsNonce=t.quformMigrateSettingsNonce),t.quformMigrateNonce&&a.migrateNonce!==t.quformMigrateNonce&&(a.migrateNonce=t.quformMigrateNonce),t.quformMigrateImportFormNonce&&a.migrateImportFormNonce!==t.quformMigrateImportFormNonce&&(a.migrateImportFormNonce=t.quformMigrateImportFormNonce))})},startMigration:function(){var e;s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),"specific"!=s.get("#qfb_migrate_forms").val()||(e=s.get("#qfb_migrate_forms_custom").val(),r.isArray(e)&&e.length)?(s.get("#qfb-migrate-progress").show(),s.get("body").css("overflow","hidden").addClass("qfb-popup-open"),s.get("#qfb-migrate-progress-bar-inner").width(0),s.get("#qfb-migrate-current-task-text").text(a.processing),"specific"==s.get("#qfb_migrate_forms").val()?(e=r.map(e,function(e){return parseInt(e,10)}),l.migrateForms(e)):r.ajax({type:"POST",url:o.ajaxUrl,data:{action:"quform_migrate_get_all_form_ids"},dataType:"json"}).done(function(e){"success"==(e=i.sanitizeResponse(e)).type&&r.isArray(e.formIds)&&e.formIds.length?l.migrateForms(e.formIds):l.migrationFailed(e.message)}).fail(function(){l.migrationFailed(o.ajaxError)}),(s.get("#qfb_migrate_license").is(":checked")||s.get("#qfb_migrate_recaptcha_keys").is(":checked"))&&r.ajax({type:"POST",url:o.ajaxUrl,data:{action:"quform_migrate_settings",_ajax_nonce:a.migrateSettingsNonce,migrate_license_key:s.get("#qfb_migrate_license").is(":checked")?"1":"0",migrate_recaptcha_keys:s.get("#qfb_migrate_recaptcha_keys").is(":checked")?"1":"0"},dataType:"json"}).done(function(e){"error"==(e=i.sanitizeResponse(e)).type&&i.addValidationError(s.get("#qfb-migrate-errors"),a.errorMigratingKeys.replace("%s",e.message))}).fail(function(){i.addValidationError(s.get("#qfb-migrate-errors"),a.errorMigratingKeys.replace("%s",o.ajaxError))})):i.addValidationError(s.get("#qfb_migrate_forms_custom").closest(i.settingInputWrap),o.thisFieldIsRequired)},migrateForms:function(e){f=(g=e).length,m=1,c=!0,s.get("#qfb-migrate-stop").css("display","inline-block"),l.migrateForm(g.shift())},migrateForm:function(t){r.ajax({type:"POST",url:o.ajaxUrl,data:{action:"quform_migrate_form",_ajax_nonce:a.migrateNonce,form_id:t,migrate_entries:s.get("#qfb_migrate_entries").is(":checked")?"1":"0"},dataType:"json"}).done(function(e){l.updateStatus(t,i.sanitizeResponse(e))}).fail(function(){l.updateStatus(t,{type:"error",message:o.ajaxError})})},updateStatus:function(e,t){var r=Math.round(m/f*100);s.get("#qfb-migrate-progress-bar-inner").width(r+"%"),m++,"error"==t.type&&i.addValidationError(s.get("#qfb-migrate-errors"),a.errorMigratingForm.replace("%d",e).replace("%s",t.message)),g.length&&c?l.migrateForm(g.shift()):l.migrationCompleted()},migrationCompleted:function(){s.get("#qfb-migrate-stop").hide(),s.get("#qfb-migrate-close").css("display","inline-block"),c?(s.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-success"),s.get("#qfb-migrate-current-task-text").text(a.migrationCompleted)):s.get("#qfb-migrate-current-task-text").text(a.migrationStopped)},migrationFailed:function(e){s.get("#qfb-migrate-stop").hide(),s.get("#qfb-migrate-close").css("display","inline-block"),i.addSubmissionError(s.get("#qfb-migrate-progress-inner"),a.errorStartingMigration.replace("%s",e)),s.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-error"),s.get("#qfb-migrate-current-task-text").text(a.migrationError)},validate:function(){if(s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),""!==s.get("#qfb-import-form-data").val())return!0;var e=s.get("#qfb-import-form-data").closest(i.settingWrap);return i.addValidationError(e,o.thisFieldIsRequired),i.scrollTo(e),!1},"import":function(){if(!n){if(!l.validate())return!1;n=!0,r.ajax({type:"POST",url:o.ajaxUrl,data:{action:"quform_migrate_import_form",_ajax_nonce:a.migrateImportFormNonce,config:s.get("#qfb-import-form-data").val()},dataType:"json"}).done(function(e){e=i.sanitizeResponse(e),s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),n=!1,"success"==e.type?l.onImportSuccess(e.message):"error"!=e.type&&"invalid"!=e.type||l.onImportFail(e)}).fail(function(){s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),n=!1,l.onImportFail({message:o.ajaxError})})}},onImportSuccess:function(e){i.showFixedMessage(e,"success",0)},onImportFail:function(e){var o;i.isNonEmptyString(e.message)&&i.showFixedMessage(a.errorImportingForm+"<br>"+e.message,"error"),e.errors&&r.each(e.errors,function(e,t){var r=s.get("#"+e).closest(i.settingWrap);o=o||r,i.addValidationError(r,t)}),o&&i.scrollTo(o)}};return r(l.init),e.tools=e.tools||{},e.tools.migrate=l,e}(quform,jQuery,quformToolsMigrateL10n,quformCoreL10n);